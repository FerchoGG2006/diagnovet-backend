# ============================================
# Cloud Build CI/CD Pipeline
# ============================================
# Este archivo define el pipeline de integraci칩n y despliegue continuo
# para DiagnoVET Backend en Google Cloud Platform
#
# Uso:
# 1. Conectar repositorio a Cloud Build
# 2. Configurar triggers para push a main/master
# 3. Configurar variables de sustituci칩n en Cloud Build

steps:
  # ========================================
  # Paso 1: Instalar dependencias y ejecutar tests
  # ========================================
  - name: 'node:18-alpine'
    id: 'install-and-test'
    entrypoint: 'sh'
    args:
      - '-c'
      - |
        echo "游닍 Instalando dependencias..."
        npm ci
        echo "游빍 Ejecutando tests..."
        npm test -- --passWithNoTests
    waitFor: ['-']

  # ========================================
  # Paso 2: Construir imagen Docker
  # ========================================
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-image'
    args:
      - 'build'
      - '-t'
      - 'gcr.io/$PROJECT_ID/diagnovet-backend:$COMMIT_SHA'
      - '-t'
      - 'gcr.io/$PROJECT_ID/diagnovet-backend:latest'
      - '--cache-from'
      - 'gcr.io/$PROJECT_ID/diagnovet-backend:latest'
      - '.'
    waitFor: ['install-and-test']

  # ========================================
  # Paso 3: Push imagen a Container Registry
  # ========================================
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-image'
    args:
      - 'push'
      - 'gcr.io/$PROJECT_ID/diagnovet-backend:$COMMIT_SHA'
    waitFor: ['build-image']

  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-latest'
    args:
      - 'push'
      - 'gcr.io/$PROJECT_ID/diagnovet-backend:latest'
    waitFor: ['build-image']

  # ========================================
  # Paso 4: Desplegar a Cloud Run
  # ========================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-cloud-run'
    entrypoint: 'gcloud'
    args:
      - 'run'
      - 'deploy'
      - 'diagnovet-backend'
      - '--image'
      - 'gcr.io/$PROJECT_ID/diagnovet-backend:$COMMIT_SHA'
      - '--region'
      - '${_REGION}'
      - '--platform'
      - 'managed'
      - '--allow-unauthenticated'
      - '--memory'
      - '512Mi'
      - '--cpu'
      - '1'
      - '--min-instances'
      - '0'
      - '--max-instances'
      - '10'
      - '--set-env-vars'
      - 'NODE_ENV=production,GCP_PROJECT_ID=$PROJECT_ID,GCS_BUCKET_NAME=${_BUCKET_NAME},GCP_PROCESSOR_ID=${_PROCESSOR_ID},GCP_PROCESSOR_LOCATION=${_PROCESSOR_LOCATION}'
      - '--set-secrets'
      - 'GOOGLE_APPLICATION_CREDENTIALS=diagnovet-sa-key:latest'
    waitFor: ['push-image']

# ========================================
# Variables de sustituci칩n
# ========================================
# Configurar estas variables en Cloud Build Triggers
substitutions:
  _REGION: 'us-central1'
  _BUCKET_NAME: 'diagnovet-reports'
  _PROCESSOR_ID: 'your-processor-id'
  _PROCESSOR_LOCATION: 'us'

# ========================================
# Im치genes a guardar en Container Registry
# ========================================
images:
  - 'gcr.io/$PROJECT_ID/diagnovet-backend:$COMMIT_SHA'
  - 'gcr.io/$PROJECT_ID/diagnovet-backend:latest'

# ========================================
# Opciones del build
# ========================================
options:
  logging: CLOUD_LOGGING_ONLY
  machineType: 'E2_MEDIUM'

# Timeout del build (15 minutos)
timeout: '900s'

# Tags para identificar builds
tags:
  - 'diagnovet'
  - 'backend'
  - 'production'
